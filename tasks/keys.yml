---
# tasks file for user keys

- name: Create local SSH key directory
  file:
    path: "{{ users_ssh_key_dir }}"
    state: directory
  when: (item.generate_ssh_key | default(false) | bool)
  delegate_to: localhost
  become: no
  run_once: yes
  tags: ['users', 'configuration']

- name: Generate SSH key
  shell: "{{ item.shell }}"
  args:
    creates: "{{ item.creates }}"
  with_items:
    - shell: "ssh-keygen -f {{ users_ssh_key_dir }}/{{ users_user.name }} -C 'Generated by Ansible'"
      creates: "{{ users_ssh_key_dir }}/{{ users_user.name }}"
    - shell: "ssh-keygen -y -f {{ users_ssh_key_dir }}/{{ users_user.name }} >
              {{ users_ssh_key_dir }}/{{ users_user.name }}.pub"
      creates: "{{ users_ssh_key_dir }}/{{ users_user.name }}.pub"
    - shell: "ssh-keygen -e -f {{ users_ssh_key_dir }}/{{ users_user.name }} -C 'Generated by Ansible' >
              {{ users_ssh_key_dir }}/{{ users_user.name }}.ppk"
      creates: "{{ users_ssh_key_dir }}/{{ users_user.name }}.ppk"
  when: (item.generate_ssh_key | default(false) | bool)
  delegate_to: localhost
  become: no
  run_once: yes
  tags: ['users', 'configuration']

- name: Copy generated SSH key pair
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  with_items:
    - src: "{{ users_ssh_key_dir }}/{{ users_user.name }}"
      dest: "{{ users_user.home | default('/home/' + users_user.name) }}/.ssh/id_rsa"
    - src: "{{ users_ssh_key_dir }}/{{ users_user.name }}.pub"
      dest: "{{ users_user.home | default('/home/' + users_user.name) }}/.ssh/id_rsa.pub"
  when: (item.generate_ssh_key | default(false) | bool)
  become: yes
  become_user: "{{ users_user.name }}"
  tags: ['users', 'configuration']

- name: Pre-setup authorized SSH keys
  authorized_key:
    user: "{{ users_user.name }}"
    key: "{{ item }}"
    path: "{{ users_user.home | default('/home/' + users_user.name) }}/.ssh/authorized_keys.tmp"
  with_items: "{{ users_user.ssh_key | default([], true) |
               union([lookup('file', '{{ users_ssh_key_dir }}/{{ users_user.name }}.pub', errors='ignore')]
               if (item.generate_ssh_key | default(false) | bool) else []) }}"
  changed_when: no
  tags: ['users', 'configuration']

- name: Examine authorized SSH keys
  stat:
    path: "{{ item }}"
  with_items:
    - "{{ users_user.home | default('/home/' + users_user.name) }}/.ssh/authorized_keys.tmp"
    - "{{ users_user.home | default('/home/' + users_user.name) }}/.ssh/authorized_keys"
  register: users_user_ssh_keys
  changed_when: no
  tags: ['users', 'configuration']

- name: Setup authorized SSH keys
  command: mv -f authorized_keys.tmp authorized_keys
  args:
    chdir: "{{ users_user.home | default('/home/' + users_user.name) }}/.ssh"
    removes: "{{ users_user.home | default('/home/' + users_user.name) }}/.ssh/authorized_keys.tmp"
  changed_when: users_user_ssh_keys.results[0].stat.checksum != users_user_ssh_keys.results[1].stat.checksum
  tags: ['users', 'configuration']
